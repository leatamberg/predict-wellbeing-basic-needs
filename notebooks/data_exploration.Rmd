---
title: "Plot data set"
html_notebook: default
---

```{r, warning = FALSE, message=FALSE}
library(readxl)
library(writexl)
library(dplyr)
library(tidyverse)
library(caret)
library(countrycode)
library(readr)
library(stats)
library(stargazer)
library(latex2exp)
library(janitor)
library(viridis)
library(factoextra)
library(modelr)
library(glmnet)
library(tidymodels)
library(mgcv)
library(sfsmisc)
library(earth)
library(pdp)
library(rpart.plot)
library(ranger)
library(rlang)
tidymodels_prefer()
# for Latex fonts: 
library(extrafont)
library(corrplot)
```

```{r}
data_2015 <- 
  read_xlsx("../data/dataset_need_satisfiers_2015.xlsx") 
country_neighbors <- 
  read_xlsx("../data/dataset_country_neighbors.xlsx")

data_all <- read_excel("../data/dataset_need_satisfiers_all_years.xlsx", 
    col_types = c("text", "text", "text", "text", 
        "numeric", "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric",
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric",
        "numeric", "numeric", "numeric",
        "numeric", "numeric", "numeric",
        "numeric", "numeric","numeric"))
```
# Pairwise correlations

```{r}

correlation_matrix <- 
  data_2015 %>% 
  select(-c(country_name, country_code, continent, region, population)) %>%  # remove non-numerical columns
  select(life_expect, life_satisfaction, undernourishment, obesity, drinking_water_basic, electricity, 
         sanitation_basic, clean_cooking_gbd, air_pollution_particles, air_pollution_ozone, uhc_who, dtp3, 
         unmet_contraception, social_support, stability, cbn_poverty, unemployment_ilo, lower_secondary_school, 
         voice, freedom, alcohol, HIV_unaids_untreated,gdp) %>%  # order as in regressions
  cor(use = "pairwise.complete.obs") %>% round(2)

colnames(correlation_matrix) <- c("Life expectancy", "Life satisfaction", "Undernourishment", "Obesity", "Drinking water", "Electricity", "Sanitation", "Clean cooking", "Air pollution (particles)", "Air pollution (ozone)", "UHC", "DTP3", "Unmet contraception", "Social support", "Stability", "CBN poverty", "Unemployment", "Lower secondary school", "Voice", "Freedom", "Alcohol", "HIV (untreated)", "GDP")

rownames(correlation_matrix) <- c("Life expectancy", "Life satisfaction", "Undernourishment", "Obesity", "Drinking water", "Electricity", "Sanitation", "Clean cooking", "Air pollution (particles)", "Air pollution (ozone)", "UHC", "DTP3", "Unmet contraception", "Social support", "Stability", "CBN poverty", "Unemployment", "Lower secondary school", "Voice", "Freedom", "Alcohol", "HIV (untreated)", "GDP")
```


```{r}
par(family = "LM Roman 10")
pdf(file = "../results/figures/correlation.pdf", width = 6.299, height = 4.72, family = "LM Roman 10", pointsize = 10)
corrplot(correlation_matrix, type = "lower", order = "original", 
         tl.col = "black", tl.srt = 45, tl.cex = 1, cl.cex = 1, family = "LM Roman 10")
dev.off()
```



# Principal component analysis

```{r}
data_pca <- 
  data_2015 %>% 
  column_to_rownames(var = 'country_name') %>% 
  select(-c(country_code, continent, region, population, life_expect, life_satisfaction)) %>% 
  select(Undernourishment = "undernourishment",
         Obesity = "obesity",
         `Drinking water` = "drinking_water_basic", 
         Electricity = "electricity",
         Sanitation = "sanitation_basic",
         `Clean cooking` = "clean_cooking_gbd", 
         `Air pollution (particles)` = "air_pollution_particles",
         `Air pollution (ozone)` = "air_pollution_ozone",
         UHC = "uhc_who", 
         DTP3 = "dtp3",
         `Unmet contraception` = "unmet_contraception",
         `Social support` = "social_support",
         Stability = "stability",
         `CBN poverty` = cbn_poverty,   
         Unemployment = "unemployment_ilo", 
         `Lower secondary school`= "lower_secondary_school", 
         Voice = "voice",
         Freedom = "freedom",
         Alcohol = "alcohol",
         `HIV (untreated)` = "HIV_unaids_untreated", 
         GDP = "gdp"
         )

pca <- prcomp(data_pca, scale = TRUE)
#print(pca)
```

Summary table of first three components
```{r}
stargazer(pca$rotation[,1:3], align = TRUE)
```


```{r}
plot(pca)
```
```{r}
fviz_contrib(pca, choice = "var")
```
Plot variables in space spanned by first two principal components

```{r}
fviz_pca_var(axes = c(1,2),
  pca,
 col.var = "contrib", # Color by contributions to the PC
 gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
 font.family = "LM Roman 10",
  title = "",
  xlab = "First dimension (54.8%)",
  ylab = "Second dimension (9.9%)",
  labelsize = 3,
  legend.title = "Contribution to both components",
  font.x = 12,
  font.y = 12,
  font.legend = 12,
  font.tickslab = 12,
  ggtheme = theme_light(),
  arrowsize = 0.4,
  repel= TRUE,
  col.circle = NA,
 legend = "top",
  select.var = list(
    name = c("Undernourishment",
         "Electricity",
         "Sanitation",
         "Clean cooking",
         "Air pollution (particles)",
         "Air pollution (ozone)",
         "UHC",
         "Unmet contraception",
         "Social support",
         "Stability",
         "CBN poverty",
         "Voice",
         "Freedom",
         "Alcohol",
         "HIV (untreated)",
         "GDP")
    )
)

ggsave("../results/figures/pca_predictors.pdf", width = 160, height = 173, units = "mm", device = cairo_pdf)


```


plot position of countries in the same space

- coloring according to life expectancy
```{r}
#options(ggrepel.max.overlaps = Inf) 
fviz_pca_ind(pca,
             col.ind = data_2015$life_expect, #"cos2", # Color by the quality of representation, # 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             #repel = TRUE,     # Avoid text overlapping,
             title = "",
             font.family = "LM Roman 10",
             geom = "text",
             xlab = "First dimension (54.8%)",
  ylab = "Second dimension (9.9%)",
  labelsize = 2,
  legend.title = "Life expectancy",
  font.x = 12,
  font.y = 12,
  font.legend = 12,
  font.tickslab = 12,
  #repel=TRUE,
            ggtheme = theme_light()
             )
ggsave("../results/figures/pca_countries_life_expect.pdf", width = 267, height = 175, units = "mm", device = cairo_pdf)
```

-coloring according to life satisfaction
```{r}
fviz_pca_ind(pca,
             col.ind = data_2015$life_satisfaction, #"cos2", # Color by the quality of representation, # 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             #repel = TRUE,     # Avoid text overlapping,
             title = "",
             font.family = "LM Roman 10",
             geom = "text",
             #xlab = "dlikj",
              xlab = "First dimension (54.8%)",
  ylab = "Second dimension (9.9%)",
  labelsize = 2,
  legend.title = "Life satisfaction",
  font.x = 12,
  font.y = 12,
  font.legend = 12,
  font.tickslab = 12,
            ggtheme = theme_light()
             )
ggsave("../results/figures/pca_countries_life_satisfaction.pdf", width = 267, height = 175, units = "mm", device = cairo_pdf)

```


variables and countries in the same plot, a bit messy
```{r}
fviz_pca_biplot(pca, repel = TRUE,
                col.var = "#2E9FDF", # Variables color
                col.ind = "#696969"  # Individuals color
                )
```


Plot life satisfaction versus life expectancy with color indicating the value of the first principle component

```{r}
data_2015 %>% 
  mutate(first_comp = ((get_pca_ind(pca))$coord)[,"Dim.1"]) %>% 
  ggplot() +
  geom_point(aes(x=life_expect,y=life_satisfaction, color=first_comp)) +
  labs(y = "Life satisfaction (0-10 Cantril scale)",
         x = "Life expectancy (years)",
       color = "First principle component") +
   scale_colour_gradientn(colours = c("#00AFBB", "#E7B800", "#FC4E07")) +
  theme_light() +
  theme(legend.position="top") +
  theme(text = element_text(size=12, family="LM Roman 10"))
ggsave(file = "../results/figures/pca_ls_le.pdf", dpi = 600,width = 160, height = 120, units = "mm",device = cairo_pdf)
```



# Other plots of the data


## CBN poverty versus World Bank poverty
```{r}
data_all %>% 
  filter(year == 2011) %>% 
  select(country_name, region, cbn_poverty, poverty_2_15) %>% 
  drop_na() %>% 
  ggplot(aes(x = poverty_2_15, y = cbn_poverty, color = region, label = country_name)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  #geom_text(aes(label=ifelse(cbn_poverty>60 | (cbn_poverty>20& poverty_2_15<30) ,as.character(country_name),'')),hjust=0,vjust=0)
  geom_text(aes(label=ifelse(abs(cbn_poverty - poverty_2_15)>8 ,as.character(country_name),'')),hjust=0,vjust=0)
ggsave(file = "../results/figures/cbn_poverty_2_15.pdf", dpi = 600, width = 8, height = 6, units = "in")
```



## School enrollment rates
```{r}
cor(data_all$primary_school, data_all$primary_school_net, use = "complete.obs")
```

```{r}
plot(data_all$secondary_school, data_all$secondary_school_net)
```
```{r}
plot(lm(secondary_school_net~secondary_school, data_all))
```
```{r}
plot(data_all$primary_school, data_all$primary_school_net)
```



```{r}
data_all %>% filter(country_name %in% c("China")) %>% 
  select(year, lower_secondary_school, upper_secondary_school, secondary_school, primary_school) %>% 
  pivot_longer(!year, names_to = "school") %>% 
  mutate(school = factor(school, levels=c("lower_secondary_school", "upper_secondary school", "secondary_school",  "primary_school"))) %>%  # to lock the ordering for ggplot
  ggplot() + 
  geom_line(aes(year, value, color = school)) +
  theme_light() +
  labs(colour = "School type") +
  xlab("Year") +
  ylab("Gross enrollment rate (%)") +
  scale_color_discrete(labels=c("Lower secondary school", "Upper secondary school", "Secondary school",  "Primary school")) +
theme(text = element_text(size=10, family="LM Roman 10"))
ggsave("../results/figures/China_school_enrollment.pdf", width = 160, height = 120, units = "mm", device = cairo_pdf)
```
## UHC and DTP3

```{r}
data_2015 %>% ggplot() +
  geom_point(aes(y= dtp3, x = uhc_who))
```

# Check skewness of variables

--> gdp and health_expenditure are skewed
particle pollution is also skewed but existing studies do not suggest diminishing effects

```{r}
data_all %>% 
  ggplot(aes(x= (health_expenditure))) + geom_histogram()
```

```{r}
data_all %>% 
  ggplot(aes(x= (air_pollution_particles))) + geom_histogram()
```
